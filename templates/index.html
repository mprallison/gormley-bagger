<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ title }}</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  
  <style>
    html, body {
      height: 100%;
      margin: 0;
      overflow: hidden;
      }

canvas {
      position: absolute;
      top: 0;
      left: 0;
      pointer-events: none;
      }

#map { position: absolute;
  top:0;
  left:0;
  width:100%;
  height:100%;
  z-index:0; 
}

/*map table layer*/
#sidebar-layer {
    display: block;
    position: absolute;
    top: 0;
    left: 0;
    width: 150px;
    height: 97.5%;
    background: rgba(255, 255, 255, 0.9);
    border: 1px solid #ddd; 
    z-index: 1000;
    overflow-y: auto;
    padding: 10px;
    box-shadow: 2px 0 5px rgba(0,0,0,0.2);
    transition: transform 0.5s ease;
    }

#sidebar-table td button {
    cursor: pointer;
    text-align: left;
    vertical-align: top;
    white-space: normal; 
    width: 100%;
    width: 125px;
    }

button {
    border-radius: 6px;
    border-width: 1px;
    border-color: black;
    cursor: pointer;
    }
    
button:hover {
  filter: brightness(90%);
  cursor: pointer;
}

#searchInput::placeholder {
    text-align: right;
    }

  </style>
</head>

<body>
  <div id="map"></div>

  <div id="sidebar-layer">
    <table id="sidebar-table">
      <thead style="position: fixed; top: 0; background: white; z-index: 1000;">
        <th style="text-align: left; width: 125px">
          Name<br>
          <input type="text" id="searchInput" placeholder="ðŸ”Ž" style="width: 100px; text-align: left;">
        </th>
      </thead>
      <tbody style="display: block; margin-top: 30px;">
        {% for loc in data %}
        <tr>
          {% if loc.status == '1' %}
          <td>
            <button style = "background-color: #93C572;" onclick="goToLocation({{ loc.latitude }}, {{ loc.longitude }})">
              {{ loc.name }}
            </button>
          </td>
          {% else %}
          <td>
          <button onclick="goToLocation({{ loc.latitude }}, {{ loc.longitude }})">
              {{ loc.name }}
            </button>
          </td>
          {% endif %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  
  <script>
    // init map
    var map = L.map('map', {
      center: [51.5074, 0.1272],
      zoom: 5,
      minZoom: 2,
      maxZoom: 16,
      zoomControl: false 
    });

    // openstreet map layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    window.layerGroup = L.layerGroup().addTo(map);
    window.map = map;

    gapIcon = L.icon({
      iconUrl: 'https://github.com/mprallison/gormley-bagger/blob/main/static/images/Untitled_.png?raw=true',
      iconSize: [45, 18],
      iconAnchor: [32, 8],
      popupAnchor: [20, 8]
    });

    {% for loc in data %}
       
      var marker = L.marker([{{ loc.latitude }}, {{ loc.longitude }}], { icon: gapIcon }).addTo(map);

      if (window.matchMedia('(hover: hover)').matches) {
        marker.bindTooltip({{ loc.name | tojson }}, {
        permanent: false,
        direction: 'top',
        offset: [-10, -4]
        })
        };

    {% endfor %}
  </script>

  <script>
    //navigate to button coords and show circle
    async function goToLocation(lat, lng) {
      const coords = [lat, lng - 0.002];

      window.map.setView(coords, 13);

      // small delay to ensure view updates
      await new Promise(resolve => setTimeout(resolve, 500));

      if (!window.map.getPane('overlayTop')) {
          window.map.createPane('overlayTop');
          window.map.getPane('overlayTop').style.zIndex = 650;
          window.map.getPane('overlayTop').style.pointerEvents = 'none';
      }

      const circle = L.circle(coords, {
          color: 'red',
          fillColor: '#f03',
          fillOpacity: 0,
          radius: 150
      }).addTo(window.map);

      // wait 1.5 seconds before removing
      await new Promise(resolve => setTimeout(resolve, 2000));
      window.map.removeLayer(circle);
      }
  </script>

<script>
  //search table
  const searchInput = document.getElementById('searchInput');
  const rows = document.querySelectorAll('#sidebar-table tbody tr');

  searchInput.addEventListener('input', function () {
      const filter = searchInput.value.toLowerCase();
      rows.forEach(row => {
      const nameText = row.cells[0].textContent.toLowerCase();
      row.style.display = nameText.includes(filter) ? '' : 'none';
      });
  });
</script>
</body>

</html>